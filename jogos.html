<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Zombie Arena - Especial</title>
<link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
<style>
html, body { margin:0; padding:0; overflow:hidden; background:#111; font-family:'Press Start 2P', monospace; }
canvas { display:block; width:100vw; height:100vh; touch-action:none; }
#restartBtn {
  position:absolute; top:50%; left:50%; transform:translate(-50%, -50%);
  font-size:24px; padding:15px 30px; background:#ff3333; color:white;
  border:none; border-radius:10px; cursor:pointer; display:none;
}
#loveText {
  position:absolute; top:calc(50% + 60px); left:50%; transform:translateX(-50%);
  color:#ff77ff; font-size:16px; text-align:center; text-shadow:0 0 8px #ff00ff; display:none;
}
</style>
</head>
<body>
<canvas id="gameCanvas"></canvas>
<button id="restartBtn">Reiniciar</button>
<div id="loveText">MARLEM EU TE AMO ‚ù§Ô∏è</div>

<script>
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');
const restartBtn = document.getElementById('restartBtn');
const loveText = document.getElementById('loveText');

function resizeCanvas(){ canvas.width=window.innerWidth; canvas.height=window.innerHeight; }
window.addEventListener('resize', resizeCanvas);
resizeCanvas();

let player, bullets, zombies, particles, lives, kills, spawnTimer, gameOver;
let ammo=6, maxAmmo=6, reloading=false, reloadTime=2000;
let specialUnlocked=false, specialShotsLeft=50;
let damageFlash=0, hitCounter=0;
let mouse={x:0,y:0};
const keys={};
let damageCooldown=0; // cooldown em frames

function resetGame(){
  player={x:canvas.width/2,y:canvas.height/2,size:40,speed:4,angle:0};
  bullets=[]; zombies=[]; particles=[]; lives=3; kills=0; spawnTimer=0; gameOver=false;
  ammo=maxAmmo; reloading=false; specialUnlocked=false; specialShotsLeft=50;
  damageFlash=0; hitCounter=0; damageCooldown=0;
  restartBtn.style.display='none'; loveText.style.display='none';
}
resetGame();

// CONTROLES
window.addEventListener('keydown', e=>keys[e.key.toLowerCase()]=true);
window.addEventListener('keyup', e=>keys[e.key.toLowerCase()]=false);
window.addEventListener('mousemove', e=>mouse={x:e.clientX, y:e.clientY});
window.addEventListener('mousedown', shoot);

function shoot(){
  if(reloading || ammo<=0 || gameOver) return;

  let angle=Math.atan2(mouse.y-player.y, mouse.x-player.x);
  bullets.push({
    x:player.x, y:player.y, dx:Math.cos(angle)*10, dy:Math.sin(angle)*10,
    size:6, special:specialUnlocked
  });

  ammo--; if(specialUnlocked) specialShotsLeft--;

  if(ammo<=0){
    reloading=true;
    setTimeout(()=>{ ammo=maxAmmo; reloading=false; }, reloadTime);
  }

  if(specialUnlocked && specialShotsLeft<=0){
    specialUnlocked=false;
    specialShotsLeft=50;
  }
}

function spawnZombie(){
  const side=Math.floor(Math.random()*4), offset=50; let x,y;
  if(side===0){ x=Math.random()*canvas.width; y=-offset; }
  else if(side===1){ x=canvas.width+offset; y=Math.random()*canvas.height; }
  else if(side===2){ x=Math.random()*canvas.width; y=canvas.height+offset; }
  else{ x=-offset; y=Math.random()*canvas.height; }
  zombies.push({x,y,size:35,speed:1.2});
}

function movePlayer(){
  let dx=0, dy=0;
  if(keys['w']) dy-=player.speed;
  if(keys['s']) dy+=player.speed;
  if(keys['a']) dx-=player.speed;
  if(keys['d']) dx+=player.speed;
  const len=Math.hypot(dx,dy);
  if(len>0){ dx/=len; dy/=len; dx*=player.speed; dy*=player.speed; }
  player.x+=dx; player.y+=dy;
  player.x=Math.max(player.size/2, Math.min(canvas.width-player.size/2, player.x));
  player.y=Math.max(player.size/2, Math.min(canvas.height-player.size/2, player.y));
  player.angle=Math.atan2(mouse.y-player.y, mouse.x-player.x);
}

function updateBullets(){
  for(let i=bullets.length-1;i>=0;i--){
    const b=bullets[i]; b.x+=b.dx; b.y+=b.dy;
    if(b.x<0||b.x>canvas.width||b.y<0||b.y>canvas.height) bullets.splice(i,1);
  }
}

function spawnParticles(x, y, count=8){
  for(let i=0;i<count;i++){
    const angle=Math.random()*Math.PI*2;
    const speed= Math.random()*4+1;
    particles.push({x:x, y:y, dx:Math.cos(angle)*speed, dy:Math.sin(angle)*speed, size:4, life:20});
  }
}

function updateParticles(){
  for(let i=particles.length-1;i>=0;i--){
    const p=particles[i];
    p.x+=p.dx; p.y+=p.dy; p.life--;
    if(p.life<=0) particles.splice(i,1);
  }
}

function updateZombies(){
  zombies.forEach(z=>{
    const dx=player.x-z.x, dy=player.y-z.y;
    const len=Math.hypot(dx,dy);
    z.x+=dx/len*z.speed; z.y+=dy/len*z.speed;
  });

  // Repuls√£o leve entre zumbis
  for(let i=0;i<zombies.length;i++){
    for(let j=i+1;j<zombies.length;j++){
      const a=zombies[i], b=zombies[j];
      const dx=b.x-a.x, dy=b.y-a.y;
      const dist=Math.hypot(dx,dy);
      const minDist=(a.size+b.size)/2;
      if(dist<minDist && dist>0){
        const overlap=(minDist-dist)/2;
        const nx=dx/dist, ny=dy/dist;
        a.x-=nx*overlap*0.5; a.y-=ny*overlap*0.5;
        b.x+=nx*overlap*0.5; b.y+=ny*overlap*0.5;
      }
    }
  }
}

function checkCollisions(){
  for(let i=bullets.length-1;i>=0;i--){
    const b=bullets[i];
    for(let j=zombies.length-1;j>=0;j--){
      const z=zombies[j];
      const dx=b.x-z.x, dy=b.y-z.y;
      if(Math.hypot(dx,dy)<z.size/2){
        spawnParticles(z.x,z.y,6);
        zombies.splice(j,1);
        if(!b.special) bullets.splice(i,1);
        kills++;
        if(kills>=15) specialUnlocked=true;
        break;
      }
    }
  }

  if(damageCooldown>0) damageCooldown--;

  for(let z of zombies){
    const dx=z.x-player.x, dy=z.y-player.y;
    const dist=Math.hypot(dx,dy);
    const minDist=(player.size+z.size)/2;

    if(dist<minDist && damageCooldown<=0){
      // Dano imediato
      hitCounter++;
      damageFlash=5;
      damageCooldown=60; // 1 segundo de invulnerabilidade

      // Repuls√£o natural menor
      const overlap=minDist-dist;
      player.x-=dx/dist*overlap*0.2; 
      player.y-=dy/dist*overlap*0.2;

      if(hitCounter>=3){
        lives--; hitCounter=0;
        if(lives<=0) endGame();
      }
    }
  }
}

function draw(){
  ctx.clearRect(0,0,canvas.width,canvas.height);

  if(damageFlash>0){
    ctx.fillStyle='rgba(255,0,0,0.3)';
    ctx.fillRect(0,0,canvas.width,canvas.height);
    damageFlash--;
  }

  bullets.forEach(b=>{ ctx.beginPath(); ctx.arc(b.x,b.y,b.size,0,Math.PI*2); ctx.fillStyle=b.special?'red':'#ffcc00'; ctx.fill(); });
  zombies.forEach(z=>{ ctx.beginPath(); ctx.arc(z.x,z.y,z.size/2,0,Math.PI*2); ctx.fillStyle='#ff4444'; ctx.fill(); });
  particles.forEach(p=>{ ctx.beginPath(); ctx.arc(p.x,p.y,p.size,0,Math.PI*2); ctx.fillStyle='orange'; ctx.fill(); });
  ctx.save(); ctx.translate(player.x,player.y); ctx.rotate(player.angle);
  ctx.fillStyle='#00aaff'; ctx.fillRect(-player.size/2,-player.size/2,player.size,player.size);
  ctx.fillStyle='#fff'; ctx.fillRect(player.size/2-2,-5,22,10);
  ctx.restore();

  ctx.fillStyle='#fff'; ctx.font='20px Arial';
  ctx.fillText(`‚ù§Ô∏è Vidas: ${lives}`,20,40);
  ctx.fillText(`üî´ Balas: ${ammo}/${maxAmmo}`,20,70);
  ctx.fillText(`üíÄ Zumbis mortos: ${kills}`,20,100);
  if(reloading){ ctx.fillStyle='orange'; ctx.fillText('Recarregando...',20,130); }
  if(specialUnlocked){ ctx.fillStyle='red'; ctx.fillText(`Arma Especial: ${specialShotsLeft} tiros`,20,160); }

  if(gameOver){
    ctx.fillStyle='red'; ctx.font='32px "Press Start 2P"';
    ctx.textAlign='center';
    ctx.fillText('GAME OVER',canvas.width/2,canvas.height/2-50);
    loveText.style.display='block';
  }
}

function gameLoop(){
  if(!gameOver){
    movePlayer();
    updateBullets();
    updateZombies();
    updateParticles();
    checkCollisions();
    spawnTimer++;
    if(spawnTimer%60===0) spawnZombie();
  }
  draw();
  requestAnimationFrame(gameLoop);
}

function endGame(){
  gameOver=true;
  restartBtn.style.display='block';
}

restartBtn.addEventListener('click', resetGame);
gameLoop();
</script>
</body>
</html>
