<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Zombie Arena - Boss Edition V3</title>
<link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
<style>
html, body { margin:0; padding:0; overflow:hidden; background:#111; font-family:'Press Start 2P', monospace; }
canvas { display:block; width:100vw; height:100vh; touch-action:none; }
#restartBtn { position:absolute; top:50%; left:50%; transform:translate(-50%, -50%); font-size:24px; padding:15px 30px; background:#ff3333; color:white; border:none; border-radius:10px; cursor:pointer; display:none; }
#loveText { position:absolute; left:50%; transform:translateX(-50%); color:#ff77ff; font-size:14px; text-align:center; text-shadow:0 0 8px #ff00ff; display:none; }
#joystickBase { position:absolute; bottom:20px; left:20px; width:120px; height:120px; background: rgba(255,255,255,0.2); border-radius:50%; display:none; touch-action:none; }
#joystickKnob { position:absolute; width:60px; height:60px; background: rgba(255,255,255,0.5); border-radius:50%; left:30px; top:30px; touch-action:none; }
#shootBtn { position:absolute; bottom:40px; right:30px; width:80px; height:80px; background:#ffcc00; border-radius:50%; font-size:16px; text-align:center; line-height:80px; color:#111; font-weight:bold; user-select:none; display:none; touch-action:none; }
</style>
</head>
<body>
<canvas id="gameCanvas"></canvas>
<button id="restartBtn">Reiniciar</button>
<div id="loveText">MARLEM EU TE AMO ‚ù§Ô∏è</div>
<div id="joystickBase"><div id="joystickKnob"></div></div>
<div id="shootBtn">üí•</div>

<script>
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');
const restartBtn = document.getElementById('restartBtn');
const loveText = document.getElementById('loveText');
const joystickBase = document.getElementById('joystickBase');
const joystickKnob = document.getElementById('joystickKnob');
const shootBtn = document.getElementById('shootBtn');

function resizeCanvas(){ canvas.width=window.innerWidth; canvas.height=window.innerHeight; }
window.addEventListener('resize', resizeCanvas);
resizeCanvas();

const isMobile = /Android|iPhone|iPad|iPod|Opera Mini|IEMobile|WPDesktop/i.test(navigator.userAgent);
if(isMobile){ joystickBase.style.display='block'; shootBtn.style.display='block'; }

const soundShoot = new Audio('https://freesound.org/data/previews/256/256113_3263906-lq.mp3'); 
const soundShootSpecial = new Audio('https://freesound.org/data/previews/458/458851_9606136-lq.mp3'); 
const soundZombieDead = new Audio('https://freesound.org/data/previews/235/235968_3989728-lq.mp3');
const soundPlayerHit = new Audio('https://freesound.org/data/previews/256/256113_3263906-lq.mp3');

let player, bullets, zombies, enemyBullets, lives, kills, spawnTimer, gameOver, explosions, bossParticles;
const maxAmmo = 6;
let ammo = maxAmmo, reloading=false, reloadTime=2000;
let mouse={x:0,y:0}; const keys={};
let screenFlash=0;
let joystick = {dx:0, dy:0, active:false};
let specialUnlocked=false, specialShotsLeft=50;
let boss=null, bossPhase=0;
const enemyShootCooldown = 4000; // inimigo dispara a cada 2x jogador

function resetGame(){
  player={x:canvas.width/2,y:canvas.height/2,size:40,speed:4,angle:0};
  bullets=[]; zombies=[]; enemyBullets=[]; lives=3; kills=0; spawnTimer=0; gameOver=false;
  ammo=maxAmmo; reloading=false; explosions=[]; bossParticles=[];
  screenFlash=0; specialUnlocked=false; specialShotsLeft=50;
  boss=null; bossPhase=0;
  restartBtn.style.display='none'; loveText.style.display='none';
  joystick.dx=0; joystick.dy=0; joystick.active=false;
}
resetGame();

// CONTROLES
if(!isMobile){
  window.addEventListener('mousemove', e=>mouse={x:e.clientX, y:e.clientY});
  window.addEventListener('keydown', e=>keys[e.key.toLowerCase()]=true);
  window.addEventListener('keyup', e=>keys[e.key.toLowerCase()]=false);
  window.addEventListener('mousedown', shoot);
} else {
  joystickKnob.addEventListener('touchstart', e=>{ joystick.active=true; });
  joystickKnob.addEventListener('touchmove', e=>{
    if(!joystick.active) return;
    const touch = e.touches[0];
    const rect = joystickBase.getBoundingClientRect();
    const cx = rect.left + rect.width/2;
    const cy = rect.top + rect.height/2;
    joystick.dx = touch.clientX - cx;
    joystick.dy = touch.clientY - cy;
    const dist = Math.hypot(joystick.dx, joystick.dy);
    const maxDist = rect.width/2 - 30;
    if(dist > maxDist){ joystick.dx = (joystick.dx/dist)*maxDist; joystick.dy = (joystick.dy/dist)*maxDist; }
    joystickKnob.style.left = `${30 + joystick.dx}px`;
    joystickKnob.style.top = `${30 + joystick.dy}px`;
  });
  joystickKnob.addEventListener('touchend', e=>{ joystick.active=false; joystick.dx=0; joystick.dy=0; joystickKnob.style.left='30px'; joystickKnob.style.top='30px'; });
  shootBtn.addEventListener('touchstart', shoot);
}

// FUN√á√ïES
function shoot(){
  if(reloading || ammo<=0 || gameOver) return;
  if(specialUnlocked && specialShotsLeft<=0) { specialUnlocked=false; specialShotsLeft=50; }

  let angle;
  if(isMobile){
    const len = Math.hypot(joystick.dx, joystick.dy);
    if(len > 0){ angle = Math.atan2(joystick.dy, joystick.dx); } else { angle = 0; }
  } else { angle = Math.atan2(mouse.y-player.y, mouse.x-player.x); }

  bullets.push({ x: player.x, y: player.y, dx: Math.cos(angle)*10, dy: Math.sin(angle)*10, size:6, special:specialUnlocked });
  ammo--; if(specialUnlocked) specialShotsLeft--;  
  if(specialUnlocked) soundShootSpecial.play(); else soundShoot.play();
  if(ammo <=0){ reloading=true; setTimeout(()=>{ ammo=maxAmmo; reloading=false; }, reloadTime); }
}

function spawnZombie(){
  if(boss) return; 
  const side=Math.floor(Math.random()*4), offset=50; let x,y;
  if(side===0){ x=Math.random()*canvas.width; y=-offset; }
  else if(side===1){ x=canvas.width+offset; y=Math.random()*canvas.height; }
  else if(side===2){ x=Math.random()*canvas.width; y=canvas.height+offset; }
  else{ x=-offset; y=Math.random()*canvas.height; }
  zombies.push({x,y,size:35,speed:1.2});
}

function movePlayer(){
  if(gameOver) return;
  let dx=0, dy=0;
  if(isMobile){
    const len=Math.hypot(joystick.dx, joystick.dy);
    if(len>5){ dx = (joystick.dx/50)*player.speed; dy = (joystick.dy/50)*player.speed; player.angle=Math.atan2(joystick.dy, joystick.dx); }
  } else {
    if(keys['w']) dy-=player.speed; if(keys['s']) dy+=player.speed; if(keys['a']) dx-=player.speed; if(keys['d']) dx+=player.speed;
    const len=Math.hypot(dx,dy); if(len>0){ dx=dx/len*player.speed; dy=dy/len*player.speed; player.angle=Math.atan2(dy,dx); }
  }
  player.x+=dx; player.y+=dy;
  player.x=Math.max(player.size/2, Math.min(canvas.width-player.size/2, player.x));
  player.y=Math.max(player.size/2, Math.min(canvas.height-player.size/2, player.y));
}

// Part√≠culas e explos√µes
function createParticles(x,y,count,color){
  for(let i=0;i<count;i++){
    bossParticles.push({x,y,dx:(Math.random()-0.5)*4,dy:(Math.random()-0.5)*4,radius:2+Math.random()*3,color});
  }
}

// BOSS E DIVIS√ïES
function handleBoss(){
  if(kills>=100 && !boss){ 
    boss={x:canvas.width/2, y:canvas.height/2, size:80, hp:20, phase:1, parts:[], shootTimer:0}; 
  }

  if(boss){
    // MOVIMENTO: persegue player
    const speed = 1.5;
    if(boss.phase===1){
      const angle=Math.atan2(player.y-boss.y, player.x-boss.x);
      boss.x+=Math.cos(angle)*speed;
      boss.y+=Math.sin(angle)*speed;

      // Disparo aleat√≥rio
      boss.shootTimer+=16; // aprox. frame
      if(boss.shootTimer>=enemyShootCooldown){
        boss.shootTimer=0;
        const shotAngle=angle + (Math.random()-0.5)*0.5;
        enemyBullets.push({x:boss.x,y:boss.y,dx:Math.cos(shotAngle)*6,dy:Math.sin(shotAngle)*6,radius:6});
      }

      bullets.forEach((b,j)=>{
        if(Math.hypot(b.x-boss.x,b.y-boss.y)<boss.size/2+b.size/2){
          bullets.splice(j,1); boss.hp--; createParticles(boss.x,boss.y,8,'purple'); 
        }
      });

      if(boss.hp<=0){ 
        boss.phase=2;
        boss.parts=[{x:boss.x-50,y:boss.y,size:50,hp:50,shootTimer:0},{x:boss.x+50,y:boss.y,size:50,hp:50,shootTimer:0}];
      }
    } else if(boss.phase===2){
      boss.parts.forEach((p,i)=>{
        const angle=Math.atan2(player.y-p.y, player.x-p.x);
        p.x+=Math.cos(angle)*speed; p.y+=Math.sin(angle)*speed;

        p.shootTimer+=16;
        if(p.shootTimer>=enemyShootCooldown){
          p.shootTimer=0;
          const shotAngle=angle + (Math.random()-0.5)*0.5;
          enemyBullets.push({x:p.x,y:p.y,dx:Math.cos(shotAngle)*6,dy:Math.sin(shotAngle)*6,radius:5});
        }

        bullets.forEach((b,j)=>{
          if(Math.hypot(b.x-p.x,b.y-p.y)<p.size/2+b.size/2){
            bullets.splice(j,1); p.hp--; createParticles(p.x,p.y,6,'yellow');
          }
        });
      });
      boss.parts = boss.parts.filter(p=>p.hp>0);
      if(boss.parts.length===0){
        boss.phase=3;
        for(let i=0;i<30;i++){
          zombies.push({x:Math.random()*canvas.width, y:Math.random()*canvas.height, size:35, speed:1.2});
        }
        createParticles(canvas.width/2, canvas.height/2,50,'orange');
        boss=null;
      }
    }
  }
}

// UPDATE
function update(){
  if(gameOver) return;

  if(!isMobile){
    const mx=mouse.x-player.x;
    const my=mouse.y-player.y;
    player.angle=Math.atan2(my,mx);
  }

  movePlayer();
  bullets=bullets.filter(b=>{ b.x+=b.dx; b.y+=b.dy; return b.x>=0 && b.x<=canvas.width && b.y>=0 && b.y<=canvas.height; });
  enemyBullets=enemyBullets.filter(b=>{ b.x+=b.dx; b.y+=b.dy; 
    if(Math.hypot(b.x-player.x,b.y-player.y)<player.size/2+b.radius){ lives--; screenFlash=5; soundPlayerHit.play(); return false; } 
    return b.x>=0 && b.x<=canvas.width && b.y>=0 && b.y<=canvas.height; 
  });

  spawnTimer++; if(spawnTimer>60){ spawnZombie(); spawnTimer=0; }

  zombies.forEach((z,i)=>{
    const angle=Math.atan2(player.y-z.y, player.x-z.x);
    z.x+=Math.cos(angle)*z.speed; z.y+=Math.sin(angle)*z.speed;

    for(let j=bullets.length-1;j>=0;j--){
      const b=bullets[j];
      if(Math.hypot(b.x-z.x,b.y-z.y)<z.size/2+b.size/2){
        if(!b.special) bullets.splice(j,1);
        zombies.splice(i,1); kills++;
        explosions.push({x:z.x,y:z.y,radius:0,maxRadius:30}); soundZombieDead.play();
        break;
      }
    }

    if(Math.hypot(z.x-player.x,z.y-player.y)<z.size/2+player.size/2){
      zombies.splice(i,1); lives--; screenFlash=5; soundPlayerHit.play();
      if(lives<=0) endGame();
    }
  });

  handleBoss();

  explosions=explosions.filter(ex=>{ ex.radius+=2; return ex.radius<=ex.maxRadius; });
  bossParticles= bossParticles.filter(p=>{ p.x+=p.dx; p.y+=p.dy; p.radius*=0.95; return p.radius>0.5; });

  if(screenFlash>0) screenFlash--;

  if(!specialUnlocked && kills>=15){ specialUnlocked=true; }

  draw();
  requestAnimationFrame(update);
}

// DRAW
function draw(){
  ctx.clearRect(0,0,canvas.width,canvas.height);

  bullets.forEach(b=>{ ctx.beginPath(); ctx.arc(b.x,b.y,b.size,0,Math.PI*2); ctx.fillStyle=b.special?'red':'#ffcc00'; ctx.fill(); });
  enemyBullets.forEach(b=>{ ctx.beginPath(); ctx.arc(b.x,b.y,b.radius,0,Math.PI*2); ctx.fillStyle='red'; ctx.fill(); });

  zombies.forEach(z=>{ ctx.beginPath(); ctx.arc(z.x,z.y,z.size/2,0,Math.PI*2); ctx.fillStyle='#ff4444'; ctx.fill(); });

  if(boss){
    if(boss.phase===1){
      ctx.fillStyle='purple'; ctx.beginPath(); ctx.arc(boss.x,boss.y,boss.size/2,0,Math.PI*2); ctx.fill();
    } else if(boss.phase===2){
      boss.parts.forEach(p=>{ ctx.fillStyle='yellow'; ctx.beginPath(); ctx.arc(p.x,p.y,p.size/2,0,Math.PI*2); ctx.fill(); });
    }
  }

  bossParticles.forEach(p=>{ ctx.beginPath(); ctx.arc(p.x,p.y,p.radius,0,Math.PI*2); ctx.fillStyle=p.color; ctx.fill(); });

  ctx.save(); ctx.translate(player.x,player.y); ctx.rotate(player.angle);
  ctx.fillStyle='#00aaff'; ctx.fillRect(-player.size/2,-player.size/2,player.size,player.size);
  ctx.fillStyle='#fff'; ctx.fillRect(player.size/2-2,-5,22,10);
  ctx.restore();

  explosions.forEach(ex=>{ ctx.strokeStyle='yellow'; ctx.lineWidth=2; ctx.beginPath(); ctx.arc(ex.x,ex.y,ex.radius,0,Math.PI*2); ctx.stroke(); });

  ctx.fillStyle='#fff'; ctx.font='20px Arial';
  ctx.fillText(`‚ù§Ô∏è Vidas: ${lives}`,20,40);
  ctx.fillText(`üî´ Balas: ${ammo}/${maxAmmo}`,20,70);
  ctx.fillText(`üíÄ Zumbis mortos: ${kills}`,20,100);
  if(reloading){ ctx.fillStyle='orange'; ctx.fillText('Recarregando...',20,130); }
  if(specialUnlocked){ ctx.fillStyle='red'; ctx.fillText(`Arma Especial: ${specialShotsLeft} tiros`,20,160); }

  if(screenFlash>0){ ctx.fillStyle='rgba(255,0,0,0.3)'; ctx.fillRect(0,0,canvas.width,canvas.height); }

  if(gameOver){
    ctx.fillStyle='rgba(0,0,0,0.6)'; ctx.fillRect(0,0,canvas.width,canvas.height);
    ctx.fillStyle='#ff3333'; ctx.font='60px Arial Black'; ctx.textAlign='center';
    ctx.fillText('GAME OVER',canvas.width/2,canvas.height/2-50);
  }
}

function endGame(){
  gameOver=true;
  restartBtn.style.display='block';
  loveText.style.display='block';
}

restartBtn.addEventListener('click',resetGame);

update();
</script>
</body>
</html>
